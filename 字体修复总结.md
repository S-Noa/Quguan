# 字体修复总结

## 问题描述

在CNN和VGG训练过程中生成的图像（预测图、Grad-CAM可视化等）存在中文字体显示问题，中文字符显示为方框，并产生大量字体警告：

```
UserWarning: Glyph 21407 (\N{CJK UNIFIED IDEOGRAPH-539F}) missing from current font.
```

## 修复方案

### 1. 创建通用字体设置工具

创建了 `font_utils.py` 模块，提供以下功能：

#### 核心功能
- **自动字体检测**：尝试常见中文字体（SimHei、Microsoft YaHei、SimSun等）
- **智能降级**：如果没有中文字体，自动切换到英文标签
- **警告抑制**：自动抑制matplotlib字体相关警告
- **标签管理**：根据字体支持情况提供中英文标签

#### 支持的字体
1. SimHei（黑体）
2. Microsoft YaHei（微软雅黑）
3. SimSun（宋体）
4. KaiTi（楷体）
5. FangSong（仿宋）
6. DejaVu Sans（备选字体）

### 2. 修复的文件

#### 2.1 CNN训练脚本 (`train.py`)
修复位置：
- **训练过程预测图**（每5个epoch生成）
- **最终预测图**（全部数据）
- **分组预测图**（bg0/bg1）

修复前：
```python
plt.xlabel('真实浓度值')
plt.ylabel('预测浓度值')
plt.title(f'Epoch {epoch + 1} 预测值 vs 真实值 (R² = {r2:.3f})')
```

修复后：
```python
labels = get_labels(CHINESE_SUPPORTED)
plt.xlabel(labels['true_concentration'])
plt.ylabel(labels['predicted_concentration'])
plt.title(f"{labels['epoch']} {epoch + 1} {labels['prediction_vs_true']} (R² = {r2:.3f})")
```

#### 2.2 VGG训练脚本 (`vgg_regression.py`)
修复位置：
- **训练过程预测图**（每5个epoch生成）
- **最终预测图**（全部数据）
- **分组预测图**（bg0/bg1）

修复方式与CNN脚本相同。

### 3. 智能标签系统

#### 中文标签（当支持中文字体时）
```python
{
    'true_concentration': '真实浓度值',
    'predicted_concentration': '预测浓度值',
    'test_results': '测试集预测结果',
    'all_data': '全部数据',
    'original_image': '原始图像',
    'gradcam_heatmap': 'Grad-CAM热力图',
    'overlay_visualization': '叠加可视化',
    'activation_intensity': '激活强度',
    'model': '模型',
    'true_conc': '真实浓度',
    'pred_conc': '预测浓度',
    'error': '误差',
    'type': '类型',
    'epoch': 'Epoch',
    'prediction_vs_true': '预测值 vs 真实值',
}
```

#### 英文标签（当不支持中文字体时）
```python
{
    'true_concentration': 'True Concentration',
    'predicted_concentration': 'Predicted Concentration',
    'test_results': 'Test Set Prediction Results',
    'all_data': 'All Data',
    'original_image': 'Original Image',
    'gradcam_heatmap': 'Grad-CAM Heatmap',
    'overlay_visualization': 'Overlay Visualization',
    'activation_intensity': 'Activation Intensity',
    'model': 'Model',
    'true_conc': 'True Conc',
    'pred_conc': 'Pred Conc',
    'error': 'Error',
    'type': 'Type',
    'epoch': 'Epoch',
    'prediction_vs_true': 'Prediction vs True',
}
```

## 测试验证

### 测试结果
运行 `test_font_fix.py` 的结果：
```
✓ 使用字体: SimHei
=== 字体修复测试 ===
中文字体支持: True
使用的标签类型: 中文
✓ 测试图像已保存: font_fix_test.png
✓ 字体类型: 中文字体
```

### 生成的测试文件
- `font_fix_test.png`：包含各种图表类型的字体测试图像

## 修复效果

### 修复前
- ❌ 中文字符显示为方框
- ❌ 大量字体警告信息
- ❌ 图像标签不清晰

### 修复后
- ✅ 中文字符正常显示（如果系统支持）
- ✅ 无字体警告信息
- ✅ 自动降级到英文标签（如果不支持中文）
- ✅ 图像标签清晰可读

## 使用方法

### 在新脚本中使用
```python
from font_utils import CHINESE_SUPPORTED, get_labels, suppress_font_warnings

# 抑制字体警告
suppress_font_warnings()

# 获取标签
labels = get_labels(CHINESE_SUPPORTED)

# 使用标签
plt.xlabel(labels['true_concentration'])
plt.ylabel(labels['predicted_concentration'])
```

### 自动化集成
字体设置在导入时自动执行，无需手动调用：
```python
from font_utils import CHINESE_SUPPORTED, get_labels
# 字体已自动设置完成
```

## 兼容性

### 支持的系统
- ✅ Windows 10/11（SimHei、Microsoft YaHei等）
- ✅ Linux（需要安装中文字体包）
- ✅ macOS（系统自带中文字体）

### 降级策略
如果系统没有中文字体：
1. 自动切换到英文标签
2. 使用DejaVu Sans等通用字体
3. 不影响程序正常运行

## 总结

通过创建通用的字体设置工具和智能标签系统，我们成功解决了CNN和VGG训练脚本中的中文字体显示问题。修复方案具有以下特点：

1. **自动化**：导入时自动设置，无需手动配置
2. **智能化**：根据系统字体支持情况自动选择标签语言
3. **兼容性**：支持多种操作系统和字体环境
4. **可扩展**：易于在其他脚本中复用

现在所有训练脚本生成的图像都能正确显示中文标签，提升了可视化效果和用户体验。 