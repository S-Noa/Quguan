# VGGå›å½’æ¨¡å‹æœ€ç»ˆä¿®å¤ä¸ä¼˜åŒ–æ€»ç»“

## ï¿½ï¿½ ä¿®å¤çš„å…³é”®é”™è¯¯

### 1. **æ•°æ®é›†åˆ’åˆ†ä¸¥é‡é”™è¯¯** â­ æ–°å‘ç°çš„è‡´å‘½é”™è¯¯
**é—®é¢˜**: `torch.utils.data.random_split`ä½¿ç”¨æ–¹å¼å®Œå…¨é”™è¯¯
- é”™è¯¯åœ°å¯¹`range(len(dataset))`è¿›è¡Œåˆ’åˆ†è€Œä¸æ˜¯å¯¹æ•°æ®é›†æœ¬èº«
- é”™è¯¯åœ°ä½¿ç”¨`.indices`å±æ€§è®¿é—®ä¸å­˜åœ¨çš„å±æ€§
- å¯¼è‡´æ•°æ®åŠ è½½å¤±è´¥æˆ–æ•°æ®æ··ä¹±

**è§£å†³**: 
- æ­£ç¡®ä½¿ç”¨`random_split`å¯¹æ•°æ®é›†è¿›è¡Œåˆ’åˆ†
- åˆ›å»ºè‡ªå®šä¹‰`TransformDataset`ç±»æ­£ç¡®åº”ç”¨ä¸åŒçš„transform
- ä½¿ç”¨å›ºå®šéšæœºç§å­ç¡®ä¿å¯é‡å¤æ€§

### 2. **ç¡¬ç¼–ç è·¯å¾„é—®é¢˜** â­ æ–°å‘ç°
**é—®é¢˜**: æ•°æ®è·¯å¾„ç¡¬ç¼–ç ä¸ºLinuxè·¯å¾„ï¼Œåœ¨Windowsç³»ç»Ÿæ— æ³•è¿è¡Œ
**è§£å†³**: 
- æ·»åŠ æ™ºèƒ½è·¯å¾„æ£€æµ‹ï¼Œæ”¯æŒå¤šç§å¯èƒ½è·¯å¾„
- æ·»åŠ `--data_path`å‘½ä»¤è¡Œå‚æ•°
- è‡ªåŠ¨é€‚é…ä¸åŒæ“ä½œç³»ç»Ÿ

### 3. **æƒé‡åˆå§‹åŒ–æ£€æµ‹é”™è¯¯** â­ ä¿®å¤
**é—®é¢˜**: ä½¿ç”¨`str(m)`æ£€æµ‹CBAMå±‚ä¸å‡†ç¡®
**è§£å†³**: ä½¿ç”¨`named_modules()`å’Œæ¨¡å—åç§°è¿›è¡Œå‡†ç¡®æ£€æµ‹

### 4. **CBAMå±‚è¢«é”™è¯¯å†»ç»“é—®é¢˜** â­ æœ€ä¸¥é‡
**é—®é¢˜**: å½“`freeze_features=True`æ—¶ï¼ŒCBAMæ³¨æ„åŠ›å±‚ä¹Ÿè¢«å†»ç»“ï¼Œå®Œå…¨æ— æ³•å­¦ä¹ 
**è§£å†³**: åˆ†åˆ«å¤„ç†VGGå±‚å’ŒCBAMå±‚çš„å†»ç»“çŠ¶æ€

### 5. **ä¼˜åŒ–å™¨é…ç½®é”™è¯¯** â­ æœ€ä¸¥é‡  
**é—®é¢˜**: ä¼˜åŒ–å™¨åªè®­ç»ƒå›å½’å¤´ï¼ŒCBAMå±‚å‚æ•°æ ¹æœ¬æ²¡æœ‰è¢«ä¼˜åŒ–
**è§£å†³**: è®­ç»ƒæ‰€æœ‰å¯è®­ç»ƒå‚æ•°ï¼Œæ·»åŠ æƒé‡è¡°å‡

### 6. **æ•°æ®å¢å¼ºç­–ç•¥ä¸å½“** â­ é‡è¦
**é—®é¢˜**: å¯¹ç§‘å­¦å®éªŒå›¾åƒä½¿ç”¨éšæœºæ°´å¹³ç¿»è½¬ç­‰ä¸åˆé€‚çš„å¢å¼º
**è§£å†³**: é‡‡ç”¨ä¿å®ˆçš„å¢å¼ºç­–ç•¥ï¼ˆå°è§’åº¦æ—‹è½¬+è½»å¾®é¢œè‰²æ‰°åŠ¨ï¼‰

### 7. **è®­ç»ƒ/éªŒè¯/æµ‹è¯•ä½¿ç”¨ç›¸åŒtransform** â­ é‡è¦
**é—®é¢˜**: éªŒè¯å’Œæµ‹è¯•é›†ä¹Ÿåº”ç”¨äº†æ•°æ®å¢å¼º
**è§£å†³**: è®­ç»ƒé›†ä½¿ç”¨å¢å¼ºï¼ŒéªŒè¯/æµ‹è¯•é›†ä»…æ ‡å‡†åŒ–

## ğŸ”§ æ–°å¢é‡è¦ä¼˜åŒ–

### 1. **æ™ºèƒ½æ•°æ®é›†åˆ’åˆ†** â­ æ–°å¢
```python
# æ­£ç¡®çš„æ•°æ®é›†åˆ’åˆ†æ–¹å¼
generator = torch.Generator().manual_seed(42)
train_dataset_base, val_dataset_base, test_dataset_base = torch.utils.data.random_split(
    full_dataset, [train_size, val_size, test_size], generator=generator
)

# è‡ªå®šä¹‰æ•°æ®é›†ç±»åº”ç”¨ä¸åŒtransform
class TransformDataset(torch.utils.data.Dataset):
    def __init__(self, base_dataset, transform, original_dataset):
        self.base_dataset = base_dataset
        self.transform = transform
        self.original_dataset = original_dataset
```

### 2. **æ™ºèƒ½è·¯å¾„æ£€æµ‹** â­ æ–°å¢
```python
possible_paths = [
    r"/root/autodl-tmp/2025å¹´å®éªŒç…§ç‰‡",  # Linuxäº‘æœåŠ¡å™¨è·¯å¾„
    r"D:\gm\2025å¹´å®éªŒç…§ç‰‡",  # Windowsæœ¬åœ°è·¯å¾„
    r".\2025å¹´å®éªŒç…§ç‰‡",  # ç›¸å¯¹è·¯å¾„
    r"2025å¹´å®éªŒç…§ç‰‡"  # å½“å‰ç›®å½•
]
```

### 3. **æ¨¡å‹ç»“æ„éªŒè¯** â­ æ–°å¢
```python
def _verify_model_structure(self):
    """éªŒè¯æ¨¡å‹ç»“æ„æ˜¯å¦æ­£ç¡®"""
    cbam_count = 0
    for name, module in self.features.named_modules():
        if 'cbam' in name and hasattr(module, 'channel_attention'):
            cbam_count += 1
    
    if cbam_count != 5:
        print(f"è­¦å‘Š: æœŸæœ›5ä¸ªCBAMå±‚ï¼Œå®é™…æ£€æµ‹åˆ°{cbam_count}ä¸ª")
```

### 4. **å¢å¼ºçš„ä¼˜åŒ–å™¨é…ç½®** â­ æ–°å¢
```python
optimizer = torch.optim.Adam(trainable_params, lr=lr, weight_decay=1e-4)
```

### 5. **å®Œå–„çš„é”™è¯¯å¤„ç†** â­ æ–°å¢
- å…¨å±€å¼‚å¸¸å¤„ç†
- GPUå†…å­˜æ¸…ç†
- æƒé‡åŠ è½½å¼‚å¸¸å¤„ç†
- é”®ç›˜ä¸­æ–­å¤„ç†

### 6. **å†…å­˜ç®¡ç†ä¼˜åŒ–** â­ æ–°å¢
- è®­ç»ƒå‰åGPUç¼“å­˜æ¸…ç†
- ç¨‹åºç»“æŸæ—¶è‡ªåŠ¨æ¸…ç†
- è¯¦ç»†çš„å†…å­˜ç›‘æ§

## ğŸ“Š æœ€ç»ˆé…ç½®å‚æ•°

### æ ¸å¿ƒé…ç½®
```python
# æ™ºèƒ½è‡ªé€‚åº”batch_size
RTX 4090 (â‰¥20GB): batch_size=192
RTX 3080 (â‰¥10GB): batch_size=96
ä½ç«¯GPU (<10GB): batch_size=32

# è®­ç»ƒç­–ç•¥
use_amp = True              # æ··åˆç²¾åº¦è®­ç»ƒ
early_stop_patience = 10    # æ—©åœè€å¿ƒå€¼
grad_clip_norm = 1.0        # æ¢¯åº¦è£å‰ª
base_lr = 0.001            # åŸºç¡€å­¦ä¹ ç‡
weight_decay = 1e-4        # æƒé‡è¡°å‡
```

### æ•°æ®å¢å¼ºç­–ç•¥
```python
# è®­ç»ƒé›†
RandomRotation(degrees=5)
ColorJitter(brightness=0.1, contrast=0.1, saturation=0.1)

# éªŒè¯/æµ‹è¯•é›†
ä»…Resize + Normalizeï¼ˆæ— å¢å¼ºï¼‰
```

### æƒé‡åˆå§‹åŒ–
```python
# çº¿æ€§å±‚ï¼šXavier uniform
# CBAMå·ç§¯å±‚ï¼šKaiming normal
# VGGå±‚ï¼šä¿æŒé¢„è®­ç»ƒæƒé‡
```

## ğŸ¯ é¢„æœŸæ€§èƒ½æå‡

### æ¨¡å‹æ•ˆæœæå‡ï¼ˆæœ€é‡è¦ï¼‰
- **æ•°æ®é›†åˆ’åˆ†æ­£ç¡®**: ç¡®ä¿è®­ç»ƒæ•°æ®çš„æ­£ç¡®æ€§å’Œä¸€è‡´æ€§
- **CBAMå±‚å¯è®­ç»ƒ**: æ³¨æ„åŠ›æœºåˆ¶æ­£å¸¸å·¥ä½œï¼Œé¢„æœŸç²¾åº¦æ˜¾è‘—æå‡
- **æ­£ç¡®çš„ä¼˜åŒ–å™¨**: æ‰€æœ‰å¯è®­ç»ƒå‚æ•°éƒ½è¢«ä¼˜åŒ–
- **åˆé€‚çš„æ•°æ®å¢å¼º**: ä¿æŒå®éªŒå›¾åƒçš„ç‰©ç†æ„ä¹‰
- **å‡†ç¡®çš„è¯„ä¼°**: éªŒè¯/æµ‹è¯•é›†æ— å¢å¼ºï¼Œç»“æœæ›´å¯ä¿¡

### è®­ç»ƒç¨³å®šæ€§æå‡
- **æ—©åœæœºåˆ¶**: é˜²æ­¢è¿‡æ‹Ÿåˆ
- **æ¢¯åº¦è£å‰ª**: é˜²æ­¢æ¢¯åº¦çˆ†ç‚¸
- **æƒé‡åˆå§‹åŒ–**: æ›´å¥½çš„æ”¶æ•›èµ·ç‚¹
- **æƒé‡è¡°å‡**: é˜²æ­¢è¿‡æ‹Ÿåˆ

### ç³»ç»Ÿå…¼å®¹æ€§æå‡
- **è·¨å¹³å°æ”¯æŒ**: Windows/Linuxè‡ªåŠ¨é€‚é…
- **æ™ºèƒ½è·¯å¾„æ£€æµ‹**: è‡ªåŠ¨æ‰¾åˆ°æ•°æ®é›†
- **é”™è¯¯å¤„ç†**: ç¨‹åºæ›´åŠ å¥å£®

## ğŸ” ä¿®å¤å‰åå¯¹æ¯”

| æ–¹é¢ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| **æ•°æ®é›†åˆ’åˆ†** | å®Œå…¨é”™è¯¯âŒ | æ­£ç¡®å®ç°âœ… |
| **è·¯å¾„å…¼å®¹æ€§** | ç¡¬ç¼–ç Linuxè·¯å¾„âŒ | æ™ºèƒ½è·¨å¹³å°æ£€æµ‹âœ… |
| **CBAMå±‚** | è¢«å†»ç»“âŒ | å¯è®­ç»ƒâœ… |
| **ä¼˜åŒ–å™¨** | åªè®­ç»ƒå›å½’å¤´âŒ | è®­ç»ƒæ‰€æœ‰å¯è®­ç»ƒå‚æ•°+æƒé‡è¡°å‡âœ… |
| **æ•°æ®å¢å¼º** | ä¸åˆé€‚çš„ç¿»è½¬âŒ | ç§‘å­¦çš„ä¿å®ˆå¢å¼ºâœ… |
| **è¯„ä¼°å‡†ç¡®æ€§** | æµ‹è¯•é›†æœ‰å¢å¼ºâŒ | æµ‹è¯•é›†æ— å¢å¼ºâœ… |
| **æƒé‡åˆå§‹åŒ–** | æ£€æµ‹é”™è¯¯âŒ | å‡†ç¡®æ£€æµ‹å’Œåˆå§‹åŒ–âœ… |
| **é”™è¯¯å¤„ç†** | åŸºç¡€âŒ | å®Œå–„çš„å¼‚å¸¸å¤„ç†âœ… |
| **å†…å­˜ç®¡ç†** | æ— ç®¡ç†âŒ | æ™ºèƒ½æ¸…ç†âœ… |
| **æ¨¡å‹éªŒè¯** | æ— éªŒè¯âŒ | ç»“æ„éªŒè¯âœ… |

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### æ¨¡å‹ç²¾åº¦
- **æ˜¾è‘—æå‡**: æ•°æ®é›†åˆ’åˆ†æ­£ç¡®ï¼ŒCBAMå±‚å¯ä»¥æ­£å¸¸å­¦ä¹ 
- **æ›´å‡†ç¡®è¯„ä¼°**: æµ‹è¯•é›†ç»“æœæ›´å¯ä¿¡
- **æ›´å¥½æ³›åŒ–**: åˆé€‚çš„æ•°æ®å¢å¼º+æƒé‡è¡°å‡

### è®­ç»ƒæ•ˆç‡
- **20-30%é€Ÿåº¦æå‡**: æ··åˆç²¾åº¦+CUDNNä¼˜åŒ–
- **æ›´ç¨³å®šæ”¶æ•›**: æ—©åœ+æ¢¯åº¦è£å‰ª+æƒé‡åˆå§‹åŒ–+æƒé‡è¡°å‡
- **èµ„æºä¼˜åŒ–**: æ™ºèƒ½batch_sizeé…ç½®+å†…å­˜ç®¡ç†

### ç³»ç»Ÿç¨³å®šæ€§
- **è·¨å¹³å°è¿è¡Œ**: Windows/Linuxè‡ªåŠ¨é€‚é…
- **é”™è¯¯æ¢å¤**: å®Œå–„çš„å¼‚å¸¸å¤„ç†
- **èµ„æºç®¡ç†**: è‡ªåŠ¨GPUå†…å­˜æ¸…ç†

## ğŸš€ ä½¿ç”¨å»ºè®®

### è¿è¡Œå‘½ä»¤
```bash
# Windowsç³»ç»Ÿï¼ˆæ¨èï¼‰
python -u vgg_regression.py --group all --data_path "D:\gm\2025å¹´å®éªŒç…§ç‰‡"

# Linuxç³»ç»Ÿ
python -u vgg_regression.py --group all --data_path "/root/autodl-tmp/2025å¹´å®éªŒç…§ç‰‡"

# è‡ªåŠ¨æ£€æµ‹è·¯å¾„
python -u vgg_regression.py --group all

# åˆ†ç»„å¯¹æ¯”è®­ç»ƒ
python -u vgg_regression.py --group allgroup
```

### å…³é”®ç›‘æ§æŒ‡æ ‡
1. **æ•°æ®é›†åˆ’åˆ†**: ç¡®è®¤è®­ç»ƒ/éªŒè¯/æµ‹è¯•é›†å¤§å°æ­£ç¡®
2. **æ¨¡å‹ç»“æ„**: ç¡®è®¤CBAMå±‚æ•°é‡ä¸º5ä¸ª
3. **å‚æ•°ç»Ÿè®¡**: ç¡®è®¤CBAMå±‚å¯è®­ç»ƒç™¾åˆ†æ¯”
4. **GPUåˆ©ç”¨ç‡**: ç›®æ ‡80-95%
5. **æ˜¾å­˜ä½¿ç”¨**: RTX 4090ç›®æ ‡18-22GB
6. **è®­ç»ƒç¨³å®šæ€§**: è§‚å¯Ÿæ—©åœå’Œæ¢¯åº¦è£å‰ªæ•ˆæœ

## ğŸ‰ æ€»ç»“

è¿™æ¬¡ä¿®å¤è§£å†³äº†VGGæ¨¡å‹ä¸­çš„**å¤šä¸ªè‡´å‘½é”™è¯¯**ï¼š
- âœ… **æ•°æ®é›†åˆ’åˆ†å®Œå…¨é‡å†™**ï¼ˆæœ€é‡è¦ï¼‰
- âœ… **è·¨å¹³å°å…¼å®¹æ€§**ï¼ˆé‡è¦ï¼‰
- âœ… **CBAMå±‚ç°åœ¨å¯ä»¥æ­£å¸¸å­¦ä¹ **ï¼ˆæœ€é‡è¦ï¼‰
- âœ… **ä¼˜åŒ–å™¨è®­ç»ƒæ‰€æœ‰å¿…è¦å‚æ•°**ï¼ˆæœ€é‡è¦ï¼‰
- âœ… **ç§‘å­¦çš„æ•°æ®å¢å¼ºç­–ç•¥**
- âœ… **å‡†ç¡®çš„æ¨¡å‹è¯„ä¼°**
- âœ… **å®Œå–„çš„é”™è¯¯å¤„ç†å’Œå†…å­˜ç®¡ç†**

ä¿®å¤åçš„VGGæ¨¡å‹ç°åœ¨å…·å¤‡äº†ï¼š
1. **æ­£ç¡®çš„æ•°æ®å¤„ç†æµç¨‹**
2. **è·¨å¹³å°è¿è¡Œèƒ½åŠ›**
3. **ä¸CNNæ¨¡å‹å…¬å¹³ç«äº‰çš„èƒ½åŠ›**
4. **å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶**
5. **ä¼˜åŒ–çš„å†…å­˜ç®¡ç†**

è¿™äº›æ”¹è¿›ç¡®ä¿äº†å®éªŒçš„ç§‘å­¦æ€§ã€ç»“æœçš„å¯ä¿¡åº¦å’Œç¨‹åºçš„å¥å£®æ€§ã€‚ 